<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Editor PDF con medidor</title>

<style>
body { font-family: Arial; background:#eee; padding:20px; }
#pdf-container {
  position: relative;
  width: 800px;
  margin: auto;
  background: #fff;
}
canvas { width:100%; border:1px solid #ccc; cursor: crosshair; }

.field {
  position:absolute;
  border:1px dashed #007bff;
  background:rgba(255,255,255,.8);
  padding:2px 4px;
  min-width:120px;
  outline:none;
}
.bold { font-weight:bold; }

#coords {
  text-align:center;
  margin-top:10px;
  font-size:14px;
  background:#222;
  color:#0f0;
  padding:5px;
}

.marker {
  position:absolute;
  width:10px;
  height:10px;
  border:2px solid red;
  border-radius:50%;
  pointer-events:none;
  transform: translate(-50%, -50%);
}
button { margin:10px auto; display:block; padding:8px 16px; }
</style>
</head>

<body>

<h2 align="center">Editor PDF con medidor de coordenadas</h2>

<div id="pdf-container">
  <canvas id="pdf"></canvas>
  <div id="marker" class="marker" style="display:none;"></div>

  <!-- CAMPOS -->
  <div class="field" contenteditable
       data-x="120" data-y="220" data-size="12" data-bold="false">
    Cliente
  </div>

  <div class="field bold" contenteditable
       data-x="120" data-y="260" data-size="14" data-bold="true">
    $ 0,00
  </div>
</div>

<div id="coords">Click en el PDF para obtener X / Y</div>

<button onclick="exportPDF()">Descargar PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
const PDF_URL = "base.pdf";
const canvas = document.getElementById("pdf");
const ctx = canvas.getContext("2d");
const scale = 1.5;

const marker = document.getElementById("marker");
const coords = document.getElementById("coords");

let pdfHeight = 0;

// Render PDF
pdfjsLib.getDocument(PDF_URL).promise.then(pdf => {
  pdf.getPage(1).then(page => {
    const viewport = page.getViewport({ scale });
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    pdfHeight = viewport.height;

    page.render({ canvasContext: ctx, viewport });

    document.querySelectorAll(".field").forEach(f => {
      f.style.left = f.dataset.x + "px";
      f.style.top = f.dataset.y + "px";
      f.style.fontSize = f.dataset.size + "px";
    });
  });
});

// Medidor de coordenadas
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const x = Math.round(e.clientX - rect.left);
  const y = Math.round(e.clientY - rect.top);

  coords.innerText = `X: ${x}  |  Y: ${y}`;

  marker.style.left = x + "px";
  marker.style.top = y + "px";
  marker.style.display = "block";
});

// Exportar PDF
async function exportPDF() {
  const bytes = await fetch(PDF_URL).then(r => r.arrayBuffer());
  const pdfDoc = await PDFLib.PDFDocument.load(bytes);

  const fontRegular = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

  const page = pdfDoc.getPages()[0];

  document.querySelectorAll(".field").forEach(f => {
    const text = f.innerText;
    const x = parseFloat(f.dataset.x);
    const y = page.getHeight() - parseFloat(f.dataset.y) - 15;
    const size = parseInt(f.dataset.size);
    const bold = f.dataset.bold === "true";

    page.drawText(text, {
      x, y, size,
      font: bold ? fontBold : fontRegular
    });
  });

  const pdfBytes = await pdfDoc.save();
  const blob = new Blob([pdfBytes], { type:"application/pdf" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "PDF_editado.pdf";
  a.click();
}
</script>

</body>
</html>
